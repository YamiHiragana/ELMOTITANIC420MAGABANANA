<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Solana Wallet Connector</title>
</head>
<body>
    <h1>Connect Your Solana Wallet</h1>
    <button id="connect-button">Connect Phantom Wallet</button>

    <div id="wallet-info" style="display: none;">
        <p><strong>Public Key:</strong> <span id="public-key"></span></p>
        <p><strong>SOL Balance:</strong> <span id="sol-balance"></span> SOL</p>
    </div>

    <div id="error-message"></div>

    <!-- Include Solana Web3.js via CDN with defer -->
    <script src="https://unpkg.com/@solana/web3.js@1.78.1/lib/index.iife.js" defer></script>

    <script defer>
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof solanaWeb3 === 'undefined') {
                document.getElementById('error-message').textContent = 'Failed to load Solana Web3.js library.';
                return;
            }

            const isPhantomInstalled = window.solana && window.solana.isPhantom;

            const connectButton = document.getElementById('connect-button');
            const walletInfo = document.getElementById('wallet-info');
            const publicKeySpan = document.getElementById('public-key');
            const solBalanceSpan = document.getElementById('sol-balance');
            const errorMessage = document.getElementById('error-message');

            const connectWallet = async () => {
                if (!isPhantomInstalled) {
                    errorMessage.innerHTML = 'Phantom Wallet is not installed. Please install it from <a href="https://phantom.app/" target="_blank">here</a>.';
                    return;
                }

                try {
                    const response = await window.solana.connect();
                    const publicKey = response.publicKey.toString();
                    publicKeySpan.textContent = publicKey;

                    const network = 'devnet';
                    const connection = new solanaWeb3.Connection(
                        solanaWeb3.clusterApiUrl(network),
                        'confirmed'
                    );

                    const balance = await connection.getBalance(new solanaWeb3.PublicKey(publicKey));
                    const solBalance = balance / solanaWeb3.LAMPORTS_PER_SOL;
                    solBalanceSpan.textContent = solBalance.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 6 });

                    walletInfo.style.display = 'block';
                    errorMessage.textContent = '';
                    connectButton.disabled = true;
                    connectButton.textContent = 'Wallet Connected';
                } catch (err) {
                    console.error(err);
                    errorMessage.textContent = 'Failed to connect to Phantom Wallet.';
                }
            };

            connectButton.addEventListener('click', connectWallet);

            if (isPhantomInstalled) {
                window.solana.on("accountChanged", (newPublicKey) => {
                    if (newPublicKey) {
                        window.location.reload();
                    } else {
                        window.location.reload();
                    }
                });
            }
        });
    </script>
</body>
</html>
