const connectWallet = async () => {
    if (!isPhantomInstalled) {
        errorMessage.innerHTML = 'Phantom Wallet is not installed. Please install it from <a href="https://phantom.app/" target="_blank">here</a>.';
        return;
    }

    try {
        // Request wallet connection
        const response = await window.solana.connect();
        console.log('Connection Response:', response);
        const publicKey = response.publicKey.toString();
        console.log('Public Key:', publicKey);
        publicKeySpan.textContent = publicKey;

        // Define the network to connect to ('devnet' for testing)
        const network = 'devnet'; // Change to 'mainnet-beta' if you have a proper RPC endpoint

        // Option 1: Using Solana's default cluster API URL (devnet)
        const connection = new solanaWeb3.Connection(
            solanaWeb3.clusterApiUrl(network),
            'confirmed'
        );

        // Option 2: Using a third-party RPC provider (Uncomment and replace with your RPC URL)
        /*
        const rpcUrl = 'https://your-custom-rpc-endpoint.com'; // Replace with your RPC endpoint
        const connection = new solanaWeb3.Connection(
            rpcUrl,
            'confirmed'
        );
        */

        // Fetch SOL balance
        const balance = await connection.getBalance(new solanaWeb3.PublicKey(publicKey));
        const solBalance = balance / solanaWeb3.LAMPORTS_PER_SOL;
        solBalanceSpan.textContent = solBalance.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 6 });

        // Load token list
        const tokenListMap = await loadTokenList();

        // Fetch SPL Token Accounts
        const tokenAccounts = await connection.getParsedTokenAccountsByOwner(
            new solanaWeb3.PublicKey(publicKey),
            {
                programId: solanaWeb3.TOKEN_PROGRAM_ID,
            }
        );
        console.log('Token Accounts:', tokenAccounts);

        // Process and display tokens
        tokenAccounts.value.forEach(tokenAccount => {
            const tokenInfo = tokenAccount.account.data.parsed.info;
            const tokenAmount = tokenInfo.tokenAmount.uiAmount;
            const tokenDecimals = tokenInfo.tokenAmount.decimals;
            const tokenMint = tokenInfo.mint;

            // Skip tokens with 0 balance
            if (tokenAmount === 0) return;

            // Get token details from the token list
            const tokenDetails = tokenListMap[tokenMint];
            const tokenSymbol = tokenDetails ? tokenDetails.symbol : 'Unknown Token';
            const tokenName = tokenDetails ? tokenDetails.name : 'Unknown Token';
            const tokenLogoURI = tokenDetails ? tokenDetails.logoURI : '';

            // Create table row
            const row = document.createElement('tr');

            // Token Logo and Name
            const tokenCell = document.createElement('td');
            if (tokenLogoURI) {
                const img = document.createElement('img');
                img.src = tokenLogoURI;
                img.alt = `${tokenSymbol} logo`;
                img.className = 'token-logo';
                tokenCell.appendChild(img);
            } else {
                // Placeholder if no logo
                const placeholder = document.createElement('div');
                placeholder.style.width = '24px';
                placeholder.style.height = '24px';
                placeholder.style.display = 'inline-block';
                placeholder.style.borderRadius = '50%';
                placeholder.style.backgroundColor = '#ccc';
                placeholder.style.marginRight = '10px';
                tokenCell.appendChild(placeholder);
            }
            const tokenNameText = document.createElement('span');
            tokenNameText.textContent = tokenName;
            tokenCell.appendChild(tokenNameText);
            row.appendChild(tokenCell);

            // Token Symbol
            const symbolCell = document.createElement('td');
            symbolCell.textContent = tokenSymbol;
            row.appendChild(symbolCell);

            // Token Balance
            const balanceCell = document.createElement('td');
            balanceCell.textContent = tokenAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 6 });
            row.appendChild(balanceCell);

            tokenTableBody.appendChild(row);
        });

        // Display wallet information
        walletInfo.style.display = 'block';
        errorMessage.textContent = '';

        // Optionally, disable the connect button after successful connection
        connectButton.disabled = true;
        connectButton.textContent = 'Wallet Connected';
    } catch (err) {
        console.error(err);
        if (err.message.includes('403')) {
            errorMessage.innerHTML = 'Access to the RPC endpoint is forbidden. Please try using a different network or configure a custom RPC endpoint.';
        } else if (err.message.includes('Connection')) {
            errorMessage.textContent = 'Failed to connect to the Solana network. Please check your internet connection and try again.';
        } else {
            errorMessage.textContent = 'Failed to connect to Phantom Wallet.';
        }
    }
};

// Add event listener to the connect button
connectButton.addEventListener('click', connectWallet);

// Optional: Listen for account changes (e.g., user switches accounts or networks)
if (isPhantomInstalled) {
    window.solana.on("accountChanged", (newPublicKey) => {
        if (newPublicKey) {
            // If a new account is connected, reload the page to update the balance and tokens
            window.location.reload();
        } else {
            // If the wallet is disconnected, reload the page
            window.location.reload();
        }
    });
}
